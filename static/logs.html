<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoClaw - –õ–æ–≥–∏</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .logs-page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logs-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        .logs-controls select,
        .logs-controls input {
            padding: 8px 12px;
            border: 1px solid #dcdde1;
            border-radius: 6px;
            background: #f5f6fa;
            font-size: 14px;
        }

        .logs-controls input {
            flex: 1;
            min-width: 200px;
        }

        .logs-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #00a8ff;
            color: white;
        }
        .btn-refresh:hover {
            background: #0097e6;
        }

        .btn-stream {
            background: #44bd32;
            color: white;
        }
        .btn-stream.streaming {
            background: #c23616;
        }
        .btn-stream:hover {
            opacity: 0.9;
        }

        .btn-clear {
            background: #718093;
            color: white;
        }
        .btn-clear:hover {
            background: #2f3640;
        }

        .logs-container {
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #2d3436;
            border-bottom: 1px solid #636e72;
            color: #dfe6e9;
            font-size: 13px;
        }

        .logs-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            display: flex;
            gap: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .log-entry:hover {
            background: rgba(255,255,255,0.05);
        }

        .log-entry.log-level-error {
            background: rgba(232, 65, 24, 0.1);
        }

        .log-entry.log-level-warn {
            background: rgba(251, 197, 49, 0.1);
        }

        .log-timestamp {
            color: #b2bec3;
            min-width: 90px;
            flex-shrink: 0;
        }

        .log-level {
            min-width: 70px;
            font-weight: 600;
            text-align: center;
        }

        .log-level-info { color: #00a8ff; }
        .log-level-warn { color: #fbc531; }
        .log-level-error { color: #e84118; }
        .log-level-debug { color: #8c7ae6; }
        .log-level-fatal { color: #c23616; }

        .log-message {
            color: #dfe6e9;
            flex: 1;
        }

        .log-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b2bec3;
        }

        .stream-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #718093;
        }
        .stream-indicator.active {
            background: #44bd32;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .log-stats {
            color: #b2bec3;
            font-size: 12px;
        }

        .logs-toolbar {
            position: sticky;
            top: 0;
            background: #1e1e1e;
            padding: 8px 10px;
            border-bottom: 1px solid #636e72;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logs-toolbar label {
            color: #b2bec3;
            font-size: 12px;
        }

        .logs-toolbar input[type="number"] {
            width: 70px;
            padding: 4px 8px;
            border: 1px solid #636e72;
            border-radius: 4px;
            background: #2d3436;
            color: #dfe6e9;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ü¶û</span>
                <span>PicoClaw</span>
            </div>
            <ul class="nav-links">
                <li><a href="/" data-page="dashboard">üìä Dashboard</a></li>
                <li><a href="/files.html" data-page="files">üìÅ –§–∞–π–ª—ã</a></li>
                <li><a href="/logs.html" data-page="logs" class="active">üìù –õ–æ–≥–∏</a></li>
            </ul>
        </nav>

        <main class="content">
            <h1 class="page-title">üìù –õ–æ–≥–∏ PicoClaw</h1>

            <div class="logs-page">
                <div class="logs-controls">
                    <select id="levelFilter">
                        <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                        <option value="INFO">INFO</option>
                        <option value="WARN">WARN</option>
                        <option value="ERROR">ERROR</option>
                        <option value="DEBUG">DEBUG</option>
                    </select>

                    <select id="timeFilter">
                        <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                        <option value="5m">5 –º–∏–Ω—É—Ç</option>
                        <option value="1h">1 —á–∞—Å</option>
                        <option value="24h">24 —á–∞—Å–∞</option>
                        <option value="7d">7 –¥–Ω–µ–π</option>
                    </select>

                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">

                    <button class="btn-refresh" id="refreshBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn-stream" id="streamBtn">‚ñ∂Ô∏è Live</button>
                    <button class="btn-clear" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>

                    <div class="log-status">
                        <span class="stream-indicator" id="streamIndicator"></span>
                        <span id="logStats" class="log-stats"></span>
                    </div>
                </div>

                <div class="logs-container">
                    <div class="logs-header">
                        <span>unit: picoclaw</span>
                        <span id="headerStats"></span>
                    </div>

                    <div class="logs-toolbar">
                        <label for="linesInput">–°—Ç—Ä–æ–∫:</label>
                        <input type="number" id="linesInput" value="100" min="10" max="1000" step="10">
                    </div>

                    <div class="logs-content" id="logsContent">
                        <div style="color: #636e72; text-align: center; padding: 20px;">
                            –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/logs.js"></script>
    <script src="/js/navigation.js"></script>
    <script>
        const logsContent = document.getElementById('logsContent');
        const refreshBtn = document.getElementById('refreshBtn');
        const streamBtn = document.getElementById('streamBtn');
        const clearBtn = document.getElementById('clearBtn');
        const levelFilter = document.getElementById('levelFilter');
        const timeFilter = document.getElementById('timeFilter');
        const searchInput = document.getElementById('searchInput');
        const linesInput = document.getElementById('linesInput');
        const streamIndicator = document.getElementById('streamIndicator');
        const logStats = document.getElementById('logStats');
        const headerStats = document.getElementById('headerStats');

        let eventSource = null;
        let isStreaming = false;

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏
        async function loadLogs() {
            const filters = {
                lines: parseInt(linesInput.value),
                level: levelFilter.value,
                since: timeFilter.value,
                search: searchInput.value
            };

            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await logsAPI.getLogs(filters);
                renderLogs(response.entries);
                logStats.textContent = `${response.total} –∑–∞–ø–∏—Å–µ–π`;
                headerStats.textContent = `–í—Å–µ–≥–æ: ${response.total}`;
            } catch (error) {
                logsContent.innerHTML = `<div style="color: #e84118; padding: 20px; text-align: center;">
                    ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                </div>`;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
            }
        }

        // –†–µ–Ω–¥–µ—Ä –ª–æ–≥–æ–≤
        function renderLogs(entries) {
            if (entries.length === 0) {
                logsContent.innerHTML = '<div style="color: #636e72; text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                return;
            }

            const html = entries.map(entry => `
                <div class="log-entry ${getLogLevelClass(entry.level)}">
                    <span class="log-timestamp">${formatTimestamp(entry.timestamp)}</span>
                    <span class="log-level log-level-${entry.level.toLowerCase()}">${entry.level}</span>
                    <span class="log-message">${escapeHtml(entry.message)}</span>
                </div>
            `).join('');

            logsContent.innerHTML = html;
            logsContent.scrollTop = logsContent.scrollHeight;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (–¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞)
        function appendLogEntry(entry) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${getLogLevelClass(entry.level)}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">${formatTimestamp(entry.timestamp)}</span>
                <span class="log-level log-level-${entry.level.toLowerCase()}">${entry.level}</span>
                <span class="log-message">${escapeHtml(entry.message)}</span>
            `;

            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
            const stats = logStats.textContent.match(/(\d+) –∑–∞–ø–∏—Å–µ–π/);
            const count = stats ? parseInt(stats[1]) + 1 : 1;
            logStats.textContent = `${count} –∑–∞–ø–∏—Å–µ–π`;
        }

        // Toggle —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
        function toggleStream() {
            if (isStreaming) {
                stopStream();
            } else {
                startStream();
            }
        }

        // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
        function startStream() {
            const filters = {
                level: levelFilter.value,
                search: searchInput.value
            };

            eventSource = logsAPI.streamLogs(
                (entry) => appendLogEntry(entry),
                (err) => {
                    console.error('Stream error:', err);
                    stopStream();
                },
                filters
            );

            isStreaming = true;
            streamBtn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
            streamBtn.classList.add('streaming');
            streamIndicator.classList.add('active');
            refreshBtn.disabled = true;
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isStreaming = false;
            streamBtn.textContent = '‚ñ∂Ô∏è Live';
            streamBtn.classList.remove('streaming');
            streamIndicator.classList.remove('active');
            refreshBtn.disabled = false;
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
        function clearLogs() {
            if (isStreaming) stopStream();
            logsContent.innerHTML = '<div style="color: #636e72; text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
            logStats.textContent = '';
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        refreshBtn.addEventListener('click', loadLogs);
        streamBtn.addEventListener('click', toggleStream);
        clearBtn.addEventListener('click', clearLogs);

        levelFilter.addEventListener('change', () => {
            if (isStreaming) stopStream();
            loadLogs();
        });

        timeFilter.addEventListener('change', loadLogs);

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (isStreaming) stopStream();
                loadLogs();
            }
        });

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadLogs();
    </script>
</body>
</html>
